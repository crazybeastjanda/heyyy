<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>360 Street View Tour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- Joystick look controls -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-joystick-look-controls@1.1.0/dist/aframe-joystick-look-controls.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: black;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-family: Arial;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,.3);
      border-top-color: #4CC3D9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  Loading panorama...
</div>

<a-scene
  webxr="referenceSpaceType: local-floor"
  vr-mode-ui="enabled: true"
  raycaster="objects: .clickable">

  <!-- Assets -->
  <a-assets>
    <img id="pano1" src="Assets/img1.avif">
    <img id="pano2" src="Assets/img2.avif">
    <img id="navArrow" src="Assets/red-pin.avif">
  </a-assets>

  <!-- SKY -->
  <a-sky id="sky" src="#pano1" rotation="0 90 0"></a-sky>

  <!-- CAMERA RIG -->
  <a-entity id="rig">
    <a-entity
      id="camera"
      camera
      look-controls="pointerLockEnabled: false"
      joystick-look-controls="enabled: true; turnSpeed: 2"
      wasd-controls="enabled: false">

      <!-- Desktop mouse cursor ONLY -->
      <a-entity
        cursor="rayOrigin: mouse"
        raycaster="objects: .clickable"
        geometry="primitive: ring; radiusInner: 0.015; radiusOuter: 0.025"
        material="color: #4CC3D9; shader: flat"
        position="0 0 -1">
      </a-entity>

    </a-entity>
  </a-entity>

  <!-- VR CONTROLLERS (CORRECT WAY) -->
  <a-entity
    laser-controls="hand: right"
    raycaster="objects: .clickable; far: 100"
    line="opacity: 0.6">
  </a-entity>

  <a-entity
    laser-controls="hand: left"
    raycaster="objects: .clickable; far: 100"
    line="opacity: 0.3">
  </a-entity>

  <!-- HOTSPOTS -->
  <a-entity id="hotspots"></a-entity>

</a-scene>

<script>
const sky = document.getElementById("sky");
const hotspotsContainer = document.getElementById("hotspots");
const loadingOverlay = document.getElementById("loadingOverlay");

let isLoading = false;
let currentNode = "point1";

/* ===============================
   NODES CONFIG (SAMPLE)
================================ */
const nodes = {
  point1: {
    sky: "#pano1",
    yaw: 90,
    hotspots: [
      { pos: "0 -1 -5", rot: "0 180 0", target: "point2" }
    ]
  },
  point2: {
    sky: "#pano2",
    yaw: -90,
    hotspots: [
      { pos: "0 -1 5", rot: "0 0 0", target: "point1" }
    ]
  }
};

/* ===============================
   LOAD NODE
================================ */
function loadNode(id) {
  if (isLoading) return;
  isLoading = true;

  const node = nodes[id];
  if (!node) return;

  loadingOverlay.style.display = "flex";

  sky.setAttribute("src", node.sky);
  sky.setAttribute("rotation", `0 ${-node.yaw} 0`);

  buildHotspots(id);

  setTimeout(() => {
    loadingOverlay.style.display = "none";
    isLoading = false;
    currentNode = id;
  }, 300);
}

/* ===============================
   BUILD HOTSPOTS
================================ */
function buildHotspots(id) {
  hotspotsContainer.innerHTML = "";
  const node = nodes[id];

  node.hotspots.forEach(h => {
    const el = document.createElement("a-image");
    el.setAttribute("src", "#navArrow");
    el.setAttribute("position", h.pos);
    el.setAttribute("rotation", h.rot);
    el.setAttribute("scale", "1.5 1.5 1.5");
    el.setAttribute("class", "clickable");

    el.addEventListener("click", () => {
      if (!isLoading) loadNode(h.target);
    });

    hotspotsContainer.appendChild(el);
  });
}

/* ===============================
   INIT
================================ */
document.querySelector("a-scene").addEventListener("loaded", () => {
  loadNode("point1");
});
</script>

</body>
</html>
